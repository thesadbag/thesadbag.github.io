<!DOCTYPE html>
<html lang="en">
  <head>
    <title>The Sad Bag</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, min-height=devie-height initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=forward_media" />
    <style>
      body {font-family: "Lato", sans-serif}
      .mySlides {display: none}
    </style>
  </head>
  <body style="height=100vh">
    
    <!-- Header -->
    <header class="w3-container w3-padding-16 w3-center w3-opacity w3-light-grey w3-xlarge">
      <h1 class="w3-wide">The Sad Bag</h1>
    </header>

	  <!-- Modal Location Services -->
    <div id="declined" class="w3-modal">
      <div class="w3-modal-content">
        <header class="w3-center w3-blue">
          <h2>I'm Sorry!</hs>
        </header>
        <div class="w3-container w3-content w3-padding-32">
          <span onclick="document.getElementById('declined').style.display='none'" class="w3-button w3-display-topright">&times;</span>
          <p>Oh, I'm sorry.  I was asking to use Location Services to let my person know where I am.  You don't have to let me do it, though.  If you change your mind, you may need to rescan the bag tag and &quot;Approve&quot; the Location Services request next time.</p>
        </div>
      </div>
    </div>
	  <!-- End Modal Location Services -->
	  
    <!-- Loading -->
    <div class="w3-center" id="loading">
      <div class="w3-container w3-content w3-padding-32" style="max-width:800px">
        <h2 class="w3-center w3-wide">Loading...</h2>
        <div class="" id="info_text">
          <span class="material-symbols-outlined w3-spin">
            forward_media
          </span>
        </div>
        <div class="w3-third w3-cell-middle w3-center" id="image">
          <img class="w3-padding" src="sadbag.png" alt="Image of a blue backpack feeling blue (i.e., a sad bag)." style="max-width: 200px">
        </div>
      </div>
    </div>
    <!-- End Loading -->

    <!-- Info -->
    <div class=" w3-hide" id="info">

  
      <div class="w3-container w3-content w3-padding-32" style="max-width:800px">

        <h2 class="w3-center w3-wide">Smart Bag Tags</h2>
        <p class="w3-opacity w3-center"><i>How they work.</i></p>
        <div class="w3-third w3-cell-middle w3-center" id="image">
          <img class="w3-padding" src="sadbag.png" alt="The Sad Bag" style="max-width: 200px">
        </div>
        <div class="w3-twothird" id="info_text">
          <p class="w3-justify">The Sad Bag smart luggage tags work using QR Codes.  Each smart luggage tag from The Sad Bag has 
						a <i><b>U</b>niversal <b>U</b>nique <b>ID</b>entifier</i> (UUID).  The UUID is shown on the tag and is contained 
						in the URL encoded in the QR Code.  Any modern smartphone camera can scan the QR Code to get to The Sad Bag website.  
						(The UUID may also be manually entered at The Sad Bag website if necessary or desired.)  The smart part of the luggage 
						tag is that the website does not reveal the phone number, etc., of the owner unless the owner enables it.</p>
          <p class="w3-justify">Any time the QR Code is scanned, an email is sent to the owner notifying them that The Sad Bag 
						smart luggage tag was scanned.  The email contains a link to update the settings so that the website will display 
						information provided by the owner.</p>
          <p class="w3-justify">The Sad Bag website provides the ability for whoever scanned the bag to add information, such as a 
						telephone number and/or other notes, and prompts them to allow the geographic location of the user (presumably standing 
						with the bag) to be reported.  This action causes another email to be sent to The Sad Bag's owner with the additional
						information.  When clicking the button to send more information, the person scanning will be asked to allow geolocation
						services to allowed so that the location of the bag can also be sent.</p>
					<h5>Get Started</h5>
          <p class="w3-justify">Scan the new smart luggage tag from The Sad Bag.  Scanning an unassigned tag brings up a registration 
						page.  The email address is the only required field.  This email address is only ever used to send email to The Sad Bag 
						owner when the smart luggage tag is scanned; it is never made public on the page.  (If it is desired to provide an email
						address to whoever scans the page, that is described below.)
          <p class="w3-justify">There are three other pieces of information that may be associated with The Sad Bag, a phone number,
						&quot;Miscellaneous&quot;, and whether The Sad Bag is lost.  If the checkbox for whether the bag is lost is checked, the
						telephone number and &quot;Miscellaneous&quot; information is shown on the website when The Sad Bag smart luggage tag is
						scanned.
          <p class="w3-justify">Again, whenever The Sad Bag smart luggage tag is scanned, an email is sent to The Sad Bag owner that includes a 
			  link to update the information.  Use this link to change/update any information and turn on/off whether any information is shown 
			  on The Sad Bag website.</p>
        </div>
      </div>
    </div>
    <!-- End Info -->

    <!-- Missing Bag -->
    <div class=" w3-hide" id="has-bag">
      <div class="w3-container w3-content w3-padding-32" style="max-width:800px">
        <h2 class="w3-center w3-wide">I'm Lost!!!</h2>
        <p class="w3-opacity w3-center"><i>I hope you can help me!?!!</i></p>
        <div class="w3-third w3-cell-middle w3-center" id="image">
          <img class="w3-padding" src="sadbag.png" alt="The Sad Bag" style="max-width: 200px">
        </div>
        <div class="w3-twothird" id="message">
          <div class="w3-card w3-border w3-hide" id="contact-info">
			      <header class="w3-container w3-center w3-red">
              <h3>My Person's Contact Information</h3>
            </header>
            <p>You can use this information to contact my person directly.</p>
            <div class="w3-content w3-container">
              <p class="w3-center" id="owner-number"></p>
              <p class="w3-center w3-hide" id="reward"></p>
              <p class="w3-center w3-hide" id="misc"></p>
            </div>
          </div>
          <p class="w3-justify">I'm just a small bag in a big world.  I'm very sad without my person.  Can you help me?</p>
          <p class="w3-justify">I think my person knows I'm gone, but I need help letting them know where I am.  You can help by clicking below to let my person know exactly where I am.  (You may be asked to allow the current location to be sent to my person so they know where I am.)</p>
          <p class="w3-justify">You can also add your contact information and a note if you wish, but you don't have to.</p>
          <form class="w3-center" name="notifier" action="javascript:void(0)" onsubmit="getLocation()">
            <p><label for="tel">Contact Number (optional):</label>
            <input class="w3-input w3-border" type="tel" id="tel" placeholder="(212) 555-1212" title="Telephone number" name="tel" pattern="^(?:\+1)?\s?\(?\d{3}\)?[\-.\s]?\d{3}[\-.\s]?\d{4}$"/></p>
  
            <p><label for="note">Note (optional):</label>
            <textarea class="w3-input w3-border" id="note" placeholder="Any information or &quot;Lost &amp; Found&quot; location can be entered here."></textarea>
            <p><button type="submit" class="w3-button w3-center w3-blue w3-button-xxlarge w3-button-block w3-button-rounder w3-ripple">Send My Location to My Person!</button></p>
  
            <input type="hidden" id="bagid" name="bagid" value="" />
          </form>
          <p class="w3-center" id="msg"><br /></p>
        </div>
      </div>
    </div>
    <!-- End Missing Bag -->

    <!-- No Bag -->
    <div class=" w3-hide" id="no-bag">
      <div class="w3-container w3-content w3-padding-32" style="max-width:800px">

        <div class="w3-third w3-cell-middle w3-center" id="image">
          <img class="w3-padding" src="sadbag.png" alt="The Sad Bag" style="max-width: 200px">
        </div>
        <div class="w3-twothird" id="message">
          <h2 class="w3-center w3-wide"><i>Did you find a bag?</i></h2>
          <p class="w3-justify">Sad Bags are bags that are missing their person.  Did you find one?  You can scan the QR Code or enter the bag number here to help this Sad Bag find it's person.</p>
          <form class="w3-center" name="alt-notifier" action="javascript:void(0)" onSubmit="sendBagID()">
            <p><label for="man_bag_id">Sad Bag ID Number:</label>
            <input class="w3-input w3-border" id="man_bag_id" placeholder="Bag ID" title="Bag ID" name="bagid" /></p>  
            <p class="w3-center w3-block"><button type="submit" class="w3-button w3-center w3-blue w3-button-xxlarge w3-block w3-button-rounder w3-ripple">Send Bag ID</button>
          </form>
          <p class="w3-center" id="msg"><br /></p>
        </div>
        <div class="w3-container w3-hide" id="contact-info">
          <h3 class="w3-center">My Person's Contact Information</h3>
          <p class="w3-center" id="owner-number"></p>
          <p class="w3-center w3-hide" id="reward"></p>
          <p class="w3-center w3-hide" id="misc"></p>
        </div>
      </div>
    </div>
    <!-- End No Bag -->

    <!-- Update -->
    <div id="update" class=" w3-hide">
      <div class="w3-container w3-content w3-padding-32" style="max-width:800px;margin-top:46px">
        <h2 class="w3-center">Update Information</h2>
        <p class="w3-justify">Update your tag information here.</p>
        <div class="card">
          <header>
            <h4 id="bag_name"></h4>
          </header>
          <form class="" name="updater" action="javascript:void(0)" onsubmit="sendUpdate()">
            <p><label for="tele_update">Telephone Number :</label>
              <input class="w3-input w3-border" id="tele_update" name="tele" type="tel" pattern="^(?:\+1)?\s?\(?\d{3}\)?[\-.\s]?\d{3}[\-.\s]?\d{4}$" /></p>
            <p><label for="reward_update">Reward :</label>
              <input class="w3-input w3-border" id="reward_update" name="reward" type="text" /></p>
            <p><label for="misc_update">Misc :</label>
              <textarea class="w3-input w3-border" id="misc_update" name="misc"></textarea></p>
            <p><input class="w3-check" id="lost_update" name="lost" type="checkbox"> <label>Bag is Lost (Show telephone number, reward, and misc fields): </label></p>
            <input type="hidden" id="bagid_update" name="bagid" value="" />
            <input type="hidden" id="uuid_update" name="uuid" value="" />
            <p class="w3-center w3-block"><button type="submit" class="w3-button w3-center w3-blue w3-button-xxlarge w3-block w3-button-rounder w3-ripple">Update</button></p>
          </form>
        </div>
        <div id="update_panel" class="w3-container w3-panel w3-blue w3-center w3-hide">
          <p id="msg_update"></p>
        </div>
      </div>
    </div>
    <!-- End Update -->
      
    <!-- Register -->
    <div id="register" class=" w3-hide">
      <div class="w3-container w3-content w3-padding-32" style="max-width:800px;margin-top:46px">
        <h2 class="w3-center">Register Bag Tag</h2>
        <div class="card">
          <header>
            <h4 class="w3-center" id="bagid_register_header">Bag Tag Number</h4>
          </header>
          <form class="" name="register" action="javascript:void(0)" onsubmit="registerBagTag()">
            <p><label for="email_registar">Email Address: </label>
              <input class="w3-input w3-border" id="email_register" name="email" type="text" placeholder="email@example.com" required/></p>
					  <p class="w3-small w3-justify">This email is never displayed to the person scanning The Sad Bag smart luggage tag.  To display an email address, add it to the Misc. element.</p>
            <p><label for="tele_register">Telephone Number: </label>
              <input class="w3-input w3-border" id="tele_register" name="tele_register" type="tel" placeholder="(111) 555-1212" pattern="^(?:\+1)?\s?\(?\d{3}\)?[\-.\s]?\d{3}[\-.\s]?\d{4}$" /></p>
            <p><label for="desc_register">Bag Description: </label>
              <input class="w3-input w3-border" id="desc_register" name="desc_register" type="tel" placeholder="Quick description of the bag with this tag" /></p>
            <p><label for="reward_register">Reward :</label>
              <input class="w3-input w3-border" id="reward_register" name="reward_register" type="text" placeholder="Reward information, only shown if bag is set to lost" /></p>
            <p><label for="misc_register">Misc :</label>
              <textarea class="w3-input w3-border" id="misc_register" name="misc" placeholder="Any information to display when the bag tag is scanned.  It only shows when the bag is set to lost.  Place an email address here, as the above email address is not used for this." ></textarea></p>
            <p><label>Bag is Lost (Show telephone number, reward, and misc fields): </label><input class="w3-check" id="lost_register" name="lost_register" type="checkbox"></p>
            <input type="hidden" id="bagid_register" name="bagid" value="" />
            <input type="hidden" id="uuid_register" name="uuid" value="" />
            <p class="w3-center w3-block"><button type="submit" class="w3-button w3-center w3-blue w3-button-xxlarge w3-block w3-button-rounder w3-ripple">Register</button></p>
          </form>
        </div>
        <div id="register_panel" class="w3-container w3-panel w3-blue w3-center w3-hide">
          <p id="msg_register"></p>
        </div>
      </div>
    </div>
    <!-- End Register -->
      
    <!-- Verified -->
    <div id="verified" class=" w3-hide">
      <div class="w3-container w3-content w3-padding-32" style="max-width:800px;margin-top:46px">
        <h2 class="w3-center">Verify Bag Tag Email</h2>
        <div class="card">
          <header>
            <h4 class="w3-center" id="bagid_verified_header" name='bag_tag_number'>Bag Tag Number</h4>
          </header>
        </div>
        <div id="register_panel" class="w3-container w3-panel w3-blue w3-center w3-hide">
          <p id="msg_register"></p>
        </div>
      </div>
    </div>
    <!-- End Verified -->

  <!-- Footer -->
    <footer class="w3-container w3-padding-16 w3-center w3-opacity w3-light-grey w3-xlarge">
      <p class="w3-medium">Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a></p>
      <p class="w3-medium">&copy; Copyright 2024-2025, The Sad Bag</p>
    </footer>
    
    <script>
      const x = document.getElementById("msg");
      const url = "https://script.google.com/macros/s/AKfycbxJ48e3HWMgR7YihNmH6um4mMaMDA5k6r2Va04f2PJkTj_oWDF4lfbdRQVpMKkIdM_Z/exec";
      let searchParams = new URLSearchParams(window.location.search);

      let geo_prompt = false
      let geo_tries = 0
      let has_bag = -1
      
      if (searchParams.has("uuid")) {
        document.getElementById("uuid").value = searchParams.get("uuid")
        document.getElementById("uuid_update").value = searchParams.get("uuid")
        if (searchParams.get('action') == 'verify'){
          contactServer({uuid: searchParams.get("uuid"), action: 'verify'})
        } else {
          contactServer({uuid: searchParams.get("uuid"), action: 'update'})
        }
      } else if (searchParams.has("bagid")) {
        const bagid_num = searchParams.get("bagid");
        document.getElementById("bagid").value = bagid_num
        contactServer({bagid: searchParams.get("bagid"), action: 'bag_check'})
        window.onload = function() {
          startTimeout(15000)
        }
      } else {
      	hide("loading");
        show("no-bag");
      }

      function contactServer(json_struct){
        console.log(JSON.stringify(json_struct))
        var get_string = ''
        for (const [key, value] of Object.entries(json_struct)) {
          get_string += "&" + key + "=" + value 
        }
        get_string = '?' + get_string.substring(1, get_string.length)
        // console.log(get_string)
        
        fetch(url + get_string, {
          method: "GET",
          headers: {
            "Content-type": "text/plain; charset=UTF-8"
          }
        }).then(response => response.text()).then(data => {fetchResponse(data)})
      }

      function fetchResponse(data){
        console.log("fetchResponse()")
        console.log(data)
        data = JSON.parse(data)
        console.log(data)

        hide('loading')


        if (data.action == 'update') {
          document.getElementById("bagid_update").value = data.bagid
          document.getElementById("uuid_update").value = data.uuid
          document.getElementById("bag_name").value = atob(data.desc)
          document.getElementById("tele_update").value = atob(data.tele)
          document.getElementById("reward_update").value = atob(data.reward)
          document.getElementById("misc_update").innerText = atob(data.misc)
          document.getElementById("lost_update").checked = data.lost == "TRUE"
          show("update")
        } else if (data.action == 'updateData') {
          hide('update')
          show('has_bag')
        } else if (data.action == 'register') {
          document.getElementById("bagid_register").value = data.bagid
          document.getElementById("uuid_register").value = data.uuid
          show("register")
        } else if (data.action == 'not_registered') {
          show('no-bag')
        } else if (data.action == 'verified') {
          document.getElementById('bagid_register_header').innerText = data.uuid
          document.getElementById("bagid_verified").innerText = data.desc + ' verified'
          show('verified')
        } else if (data.action == 'not_verified'){
          document.getElementById('bagid_register_header').innerText = data.uuid
          document.getElementById("bagid_verified").innerText = data.desc + ' not verified'
          show('verified')			
        } else if (data.action == 'no_bag') {
          show('no-bag')
        } else if (data.action == 'has_bag') {
          if (data.lost == "TRUE") {
            if (data.tele.length > 0){
              document.getElementById('owner-number').innerHTML = 'Telephone Number: ' + '<a href="' + atob(data.tele) + '">' + atob(data.tele) + '</a>'
            }
            if (data.reward.length > 0){
              document.getElementById('reward').innerText = 'Reward: ' + atob(data.reward)
              show('reward')
            }
            if (data.misc.length > 0) {
              document.getElementById('misc').innerText = atob(data.misc)
              show('misc')
            }
            show('contact-info')
          }
          show('has-bag')
        }
      }
        
      function sendEmail(lat='', lon='', note='') {
        if (note != ''){
          note += '\n\n' + document.getElementById('note').value
        }
        if (note == '') {
          note = '[NO NOTE]'
        }
        if (lat == '') {
          lat = '[NO LAT]'
          lon = '[NO LON]'
        }
        
        contactServer({bagid: document.getElementById("bagid").value, 
                       lat: lat,
                       lon: lon,
                       tele: btoa(document.getElementById('tel').value), 
                       note: btoa(note),
                       action: 'sendEmail'})
      }
      
      function sendBagID() {
        document.getElementById("bagid").value = document.getElementById("man_bag_id").value
        hide("no-bag")
        hide("has-bag")
        show("loading")      
        sendEmail();
      }
      
      function registerBagTag() {
				if (document.getElementById("lost_register").checked == true) {
				  var losted = "TRUE"
				} else {
					var losted = "FALSE"
				}
        contactServer({action: "register",
					   bagid: document.getElementById("bagid").value,
					   desc: btoa(document.getElementById("desc_register").value),
					   email: btoa(document.getElementById("email_register").value),
                       tele: btoa(document.getElementById("tele_register").value),
                       reward: btoa(document.getElementById("reward_register").value),
                       misc: btoa(document.getElementById("misc_register").innerText),
                       lost: losted})
      }

      function sendUpdate() {
				if (document.getElementById("lost_update").checked == true) {
				  var losted = "TRUE"
				} else {
					var losted = "FALSE"
				}
        contactServer({uuid: document.getElementById("uuid_update").value,
                       action: "updateData",
                       tele: btoa(document.getElementById("tele_update").value),
                       reward: btoa(document.getElementById("reward_update").value),
                       misc: btoa(document.getElementById("misc_update").innerText),
                       lost: losted})
      }
      
      function startTimeout(timeout=5000) {
        setTimeout(timeoutFunc, timeout)
      }
      
      function timeoutFunc() {
        if (has_bag < 0) {
          startTimeout(timeoutFunc, 15000)
        } else if ( has_bag > 0) {
          if (geo_prompt){
            return 
          }
          getLocation()
        }
        return
      }

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else { 
          sendEmail('', '', 'GeoLocation Unavailable')
        }
      }

      function showPosition(position) {
        geo_prompt = true
        // console.log(position)
        sendEmail(position.coords.latitude, position.coords.longitude)
      }

      function showError(error) {
        // console.log(error)
        geo_prompt = true
        geo_tries++
        // x.innerHTML = x.innerHTML + "There was an error... <br />"
        switch(error.code) {
          case error.PERMISSION_DENIED:
            var note = '***User Refused Geolocation***'
            var try_again = false
            geo_tries = 7
            document.getElementById('declined').style.display='block'
            break;
          case error.POSITION_UNAVAILABLE:
            var note = '***Position Unavailable***'
            var try_again = true
            break;
          case error.TIMEOUT:
            var note = '***Geolocation Timedout***'
            var try_again = true
            break;
          case error.UNKNOWN_ERROR:
            var note = '***Unknown Geolocation Error***'
            var try_agian = true
            break;
        }
        sendEmail("", "", note)
  
        if ((try_again) && (geo_tries < 6)) {
          setTimeout(timeoutFunc, 5000)
        }
      }
      
      function show_hide(id) {
        var x = document.getElementById(id);
        if (x.className.indexOf("w3-hide") == -1) {
          x.className += " w3-hide";
        } else {
          x.className = x.className.replace(" w3-hide", "");
        }
      }

      function hide(id) {
        var x = document.getElementById(id);
        if (x.className.indexOf("w3-hide") == -1) {
          x.className += " w3-hide";
        }
      }

      function show(id) {
        var x = document.getElementById(id);
        if (x.className.indexOf("w3-hide") != -1) {
          x.className = x.className.replace(" w3-hide", "");
        }
      }

    </script>

  </body>
</html>
